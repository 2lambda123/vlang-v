<html>
  <head>
    <title>@title</title>
    <meta charset="utf-8" />
    @css 'assets/site.css'
  </head>
  <body>
    <h1>@title</h1>
    <button>Close the connection</button>
    <ul></ul>
    <script>
      "use strict";
      var button = document.querySelector("button");
      var eventList = document.querySelector("ul");

      const localEventSource = new EventSource("/sse");

      localEventSource.onerror = function () {
        console.error("EventSource failed.");
      };

      console.log(localEventSource.withCredentials);
      console.log(localEventSource.readyState);
      console.log(localEventSource.url);

      localEventSource.onopen = function () {
        console.log("Self connection opened.");
      };

      localEventSource.onmessage = function (e) {
        var newElement = document.createElement("li");
        newElement.textContent = "message: " + e.data;
        eventList.appendChild(newElement);
      };

      localEventSource.addEventListener(
        "ping",
        function (e) {
          console.log(e);
          var newElement = document.createElement("li");
          var obj = JSON.parse(e.data);
          newElement.innerHTML =
            "ping at " + obj.time + " server data: " + e.data;
          eventList.appendChild(newElement);
        },
        false
      );

      button.onclick = function () {
        console.log("Local connection closed");
        localEventSource.close();
      };

      const backEndEventSource = new EventSource("http://localhost:3001/sse");
      backEndEventSource.onerror = function () {
        console.error("BAck-end EventSource failed.");
      };

      console.log(backEndEventSource.withCredentials);
      console.log(backEndEventSource.readyState);
      console.log(backEndEventSource.url);

      backEndEventSource.onopen = function () {
        console.log("Back-end connection opened.");
      };

      backEndEventSource.onmessage = function (e) {
        console.log("new message received", e.data);
      };

      backEndEventSource.addEventListener(
        "notification",
        function (e) {
          console.log(e);

          var obj = JSON.parse(e.data);
          alert(obj.message);
        },
        false
      );
      button.onclick = function () {
        console.log("Back-end connection closed");
        backEndEventSource.close();
      };
    </script>
  </body>
</html>
